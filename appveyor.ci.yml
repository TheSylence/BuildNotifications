version: 0.1.{build}
skip_tags: true
image: Visual Studio 2019
configuration: Release
init:
- ps: Update-AppveyorBuild -Version "$($env:APPVEYOR_REPO_BRANCH)-$($env:APPVEYOR_REPO_COMMIT.substring(0,7))"
environment:
  CODACY_PROJECT_TOKEN:
    secure: h6bHJ858ESn0aT/lw91WDwp1SLTWvqYipdiJNNoUO5FJYFL0xsexrB6R9++zt8pD
install:
- ps: >-
    Invoke-WebRequest -Uri 'https://github.com/codacy/codacy-coverage-reporter/releases/download/4.0.5/codacy-coverage-reporter-4.0.5-assembly.jar' -UseBasicParsing -OutFile  ./codacy-test-reporter.jar
    
    & dotnet tool install --global coverlet.console
    
    & dotnet add BuildNotifications.Core.Tests/BuildNotifications.Core.Tests.csproj package coverlet.msbuild
    
    & dotnet add BuildNotifications.Tests/BuildNotifications.Tests.csproj package coverlet.msbuild
    
    & dotnet restore
before_build:
- ps: nuget restore
build:
  parallel: true
  verbosity: normal
test_script:
- ps: >-
    dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura /p:CoverletOutput=coverage /p:Exclude=[xunit.*]* BuildNotifications.sln

    & If (-not $env:APPVEYOR_PULL_REQUEST_NUMBER) { java -jar ./codacy-test-reporter.jar report -l CSharp -r ./BuildNotifications.Core.Tests/coverage.cobertura.xml -t $env:CODACY_PROJECT_TOKEN }